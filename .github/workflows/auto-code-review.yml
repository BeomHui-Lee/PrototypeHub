name: Auto Code Review

on:
  pull_request:
    types: [opened, synchronize]
    branches:
      - main

jobs:
  code-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Get changes for review
        id: get-changes
        run: |
          if [ "${{ github.event.before }}" = "0000000000000000000000000000000000000000" ]; then
            # New PR - Get full diff
            DIFF=$(git diff ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }})
          else
            # Updated PR - Get only new changes
            DIFF=$(git diff ${{ github.event.before }} ${{ github.event.after }})
          fi
          echo "DIFF<<EOF" >> $GITHUB_ENV
          echo "$DIFF" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Generate Code Review
        id: generate-review
        uses: actions/github-script@v7
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          DIFF: ${{ env.DIFF }}
        with:
          script: |
            const OpenAI = require('openai');
            
            const openai = new OpenAI({
              apiKey: process.env.OPENAI_API_KEY
            });
            
            const prompt = `ë‹¤ìŒ ì½”ë“œ ë³€ê²½ì‚¬í•­ì„ ë¦¬ë·°í•´ì£¼ì„¸ìš”:
            
            ${process.env.DIFF}
            
            ë‹¤ìŒ ê°€ì´ë“œë¼ì¸ì„ ë”°ë¼ ë¦¬ë·°í•´ì£¼ì„¸ìš”:
            1. ì½”ë“œ í’ˆì§ˆ, ì„±ëŠ¥, ë³´ì•ˆ ê´€ì ì—ì„œ ë¶„ì„
            2. ì˜ëœ ì ê³¼ ê°œì„ ì ì„ ëª…í™•íˆ êµ¬ë¶„
            3. êµ¬ì²´ì ì¸ ê°œì„  ì œì•ˆ í¬í•¨
            4. ì¹œê·¼í•˜ê³  ê±´ì„¤ì ì¸ í†¤ ìœ ì§€`;
            
            const completion = await openai.chat.completions.create({
              model: "gpt-4o-mini",
              messages: [
                {
                  role: "system",
                  content: "ë‹¹ì‹ ì€ 15ë…„ì°¨ ì‹œë‹ˆì–´ ê°œë°œìì…ë‹ˆë‹¤. ì½”ë“œ ë¦¬ë·°ë¥¼ ì¹œê·¼í•˜ê³  ê±´ì„¤ì ì¸ í†¤ìœ¼ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”."
                },
                {
                  role: "user",
                  content: prompt
                }
              ],
              max_tokens: 1000,
            });
            
            const review = completion.choices[0].message.content;
            
            // Add review comment to PR
            const reviewComment = `## ğŸ¤– AI ì½”ë“œ ë¦¬ë·°

            ${review}
            
            ---
            ì´ ë¦¬ë·°ëŠ” GPT-4o-miniì— ì˜í•´ ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: reviewComment
            });